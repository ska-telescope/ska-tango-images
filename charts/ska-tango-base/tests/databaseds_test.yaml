---
suite: databaseds
templates:
  - databaseds.yaml
tests:
  - it: should have two documents rendered.
    asserts:
      - hasDocuments:
          count: 2

  - it: should have the correct apiVersion, apps/v1, for the StatefulSet resource.
    documentIndex: 1
    asserts:
      - isKind:
          of: StatefulSet
      - isAPIVersion:
          of: apps/v1
  
  - it: should have the correct apiVersion, apps/v1, for the Service resource.
    documentIndex: 0
    asserts:
      - isKind:
          of: Service
      - isAPIVersion:
          of: v1
  
  - it: should have a service of type NodePort listening on port 10000.
    documentIndex: 0
    asserts:
      - equal:
          path: spec.type
          value: NodePort
      - equal:
          path: spec.ports[0].port
          value: 10000

  - it: should have the databaseds listening on port 10000.
    documentIndex: 1
    asserts:
      - equal:
          path: spec.template.spec.containers[0].ports[0].containerPort
          value: 10000

  - it: should have a Service that routes traffic to the pods with labels.
    documentIndex: 0
    asserts:
      - equal:
          path: spec.selector
          value:
            app: ska-tango-images
            component: databaseds
            domain: tango-configuration
            function: tangodb-interface
            intent: production

  - it: should have a Statfulset with pods having labels.
    documentIndex: 1
    asserts:
      - equal:
          path: spec.selector.matchLabels
          value:
            app: ska-tango-images
            component: databaseds
            domain: tango-configuration
            function: tangodb-interface
            intent: production

  - it: should set the service name to its own cluster hostname.
    documentIndex: 1
    asserts:
      - equal:
          path: spec.serviceName
          value: databaseds-tango-base-RELEASE-NAME

  - it: should have one replica of the statefulset
    documentIndex: 1 
    asserts:
      - equal:
          path: spec.replicas
          value: 1

  - it: should use the docker image artefact.skao.int/ska-tango-images-tango-cpp.
    documentIndex: 1
    asserts:
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: artefact.skao.int/ska-tango-images-tango-cpp

  - it: should pull the image if it is not present.
    documentIndex: 1
    asserts:
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: IfNotPresent

  - it: shouldn't have the readiness and liveness probes setup.
    documentIndex: 1
    asserts:
      - isEmpty:
          path: spec.template.spec.containers[0].readinessProbe
      - isEmpty:
          path: spec.template.spec.containers[0].livenessProbe
           
  - it: should set the correct environment variables for the MYSQL database.
    documentIndex: 1
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content: 
            name: MYSQL_HOST
            value: ska-tango-base-tangodb:3306
      - contains:
          path: spec.template.spec.containers[0].env
          content: 
            name: MYSQL_DATABASE
            value: tango
      - contains:
          path: spec.template.spec.containers[0].env
          content: 
            name: MYSQL_USER
            value: tango
      - contains:
          path: spec.template.spec.containers[0].env
          content: 
            name: MYSQL_PASSWORD
            value: tango
        
  - it: should have LoadBalancer type service if enabled in global minikube.
    documentIndex: 1
    set:
      global:
        minikube: true
    asserts:
      - isKind:
          of: Service
      - equal:
          path: spec.type
          value: LoadBalancer
  - it: should generate a command for the DatabaseDS parameterized by its tango_host, databaseds-test:40000
    documentIndex: 1
    set:
      global:
        tango_host: databaseds-test:40000
        tries: 2
        sleep: 5
      tangodb:
        component: tangodb-test
    asserts:
      - equal:
          path: spec.template.spec.containers[0].command
          value:
            - retry
            - --tries=2
            - --sleep=5
            - --
            - /usr/local/bin/wait-for-it.sh
            - ska-tango-base-tangodb-test:3306
            - --timeout=60
            - --strict
            - --
            - /usr/local/bin/DataBaseds
            - "2"
            - -ORBendPoint
            - giop:tcp::40000
            - -ORBendPointPublish
            - giop:tcp:databaseds-test:40000
