---
suite: ingress
templates:
  - ingress.yaml
tests:
  - it: should have one document rendered.
    set:
      ingress.enabled: true
    asserts:
      - hasDocuments:
          count: 1

  - it: should have the correct apiVersion, networking.k8s.io/v1, for the Ingress resource.
    documentIndex: 0
    set:
      ingress.enabled: true
    asserts:
      - isKind:
          of: Ingress
      - isAPIVersion:
          of: networking.k8s.io/v1

  - it: should have a service of tango rest listening on port 8080 for nginx.
    documentIndex: 0
    set:
      ingress.enabled: true
      ingress.nginx: true
      annotations: null
      tangorest:
        component: tango-rest-test
    asserts:
      - equal:
          path: spec.rules[0].http.paths[0].backend.service.name
          value: ska-tango-base-tango-rest-test
      - equal:
          path: spec.rules[0].http.paths[0].backend.service.port.number
          value: 8080
      - equal:
          path: metadata.annotations
          value:
            kubernetes.io/ingress.class: nginx
            nginx.ingress.kubernetes.io/rewrite-target: "/$1"

  - it: should have a Service resource of tango rest listening on port 8080 for traefik if nginx is set to false.
    set:
       annotations: null
       ingress.enabled: true
       ingress.nginx: false
       tangorest:
        component: tango-rest-test
    documentIndex: 0
    asserts:
      - equal:
          path: spec.rules[0].http.paths[0].backend.service.name
          value: ska-tango-base-tango-rest-test
      - equal:
          path: spec.rules[0].http.paths[0].backend.service.port.number
          value: 8080
      - equal:
          path: metadata.annotations
          value:
            kubernetes.io/ingress.class: traefik
            traefik.ingress.kubernetes.io/request-modifier: "ReplacePathRegex: /NAMESPACE/(.*) /$1"

  - it: should have a Ingress resource with pods having labels specified in the values.yaml file.
    documentIndex: 0
    set:
      ingress.enabled: true
      tangorest:
        component: tango-rest-test
        function: tango-http-interface-test
        domain: tango-configuration-test
        intent: enabling-test
    asserts:
      - equal:
          path: metadata.labels
          value:
            app: ska-tango-images
            component: tango-rest-test
            function: tango-http-interface-test
            domain: tango-configuration-test
            intent: enabling-test
