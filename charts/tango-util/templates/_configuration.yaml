{{- define "tango-util.configuration.tpl" -}}
---
# Device Server configurations
# Parameter: name, config filename (i.e. data/cspconfig.json)
apiVersion: v1
kind: ConfigMap
metadata:
  name: "{{ .name }}-configuration"
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "global.labels" . | indent 4 }}
    component: configurator
    function: deployment
    intent: enabling
    domain: self-configuration
data:
  dsconfig-data.json:
{{- $path := printf "data/%s/*" .config }}
{{ (tpl (.Files.Glob $path).AsConfig . ) | indent 2  }}
  bootstrap.sh: |
    #/bin/sh
    json2tango -w -a -u data/dsconfig-data.json
    rc=$?
    if [ $rc -eq 0 ]; then
      echo "finished normally."
      exit 0
    else
      if [ $rc -eq 2 ]; then
        echo "finished with an update."
        exit 0
      else
        echo "finished with an ERROR."
        exit $rc
      fi
    fi

---
# run once Job for loading Device Server config
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ template "csp-proto.name" . }}-configurator
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "global.labels" . | indent 4 }}
    component: configurator
    function: deployment
    intent: enabling
    domain: self-configuration
spec:
  ttlSecondsAfterFinished: 100
  template:
    spec:
      initContainers:
      - name: check-databaseds-ready
        image: {{ .global.Values.dsconfig.image.registry }}/{{ .global.Values.dsconfig.image.image }}:{{ .global.Values.dsconfig.image.tag }}
        imagePullPolicy: {{ .global.Values.dsconfig.image.pullPolicy }}
        command:
          - /usr/local/bin/wait-for-it.sh
          - $TANGO_HOST
          - --timeout=60
          - --strict
          - --
          - echo databaseds ready
        env:
        - name: TANGO_HOST
          value: {{ .global.tango_host }}
{{ include ".global.environment_variables" .global |indent 8 }}
      containers:
      - name: dsconfig
        image: "{{ .Values.dsconfig.image.registry }}/{{ .Values.dsconfig.image.image }}:{{ .Values.dsconfig.image.tag }}"
        imagePullPolicy: {{ .Values.dsconfig.image.pullPolicy }}
        command: # exit code 2 is CONFIG_APPLIED - https://github.com/MaxIV-KitsControls/lib-maxiv-dsconfig/blob/master/dsconfig/utils.py#L11 !!!! this should not be an error !!!!
          - sh
          - data/bootstrap.sh
        env:
        - name: TANGO_HOST
          value: {{ .global.tango_host }}
{{ include ".global.environment_variables" .global |indent 8 }}
        volumeMounts:
          - name: configuration
            mountPath: data
            readOnly: true
      volumes:
        - name: configuration
          configMap:
            name: "{{ .name }}-configuration"
      restartPolicy: Never

{{- end -}}