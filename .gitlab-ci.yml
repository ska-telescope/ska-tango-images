image: $SKA_K8S_TOOLS_DOCKER_BUILDER_IMAGE

stages:
- build_0
- build_1
- build_2
- build_3
- build_4
- build_5
# - push
- test
- publish
- cleanup_build

# https://docs.gitlab.com/ee/ci/docker/using_docker_build.html#authenticating-to-the-container-registry
before_script:
  - echo $CAR_OCI_REGISTRY_PASSWORD | docker login -u $CAR_OCI_REGISTRY_USERNAME --password-stdin $CAR_OCI_REGISTRY_HOST

build_dependencies:
  retry: 2
  stage: build_1
  variables:
    IMAGE_FOLDER: tango/tango-dependencies
  tags:
  - k8srunner
  script: 
  - &build_push |
    cd docker 
    make BUILD_ARGS="--no-cache" -C $IMAGE_FOLDER build
    make BUILD_ARGS="--no-cache" -C $IMAGE_FOLDER push
  only:
    changes:
    - docker/tango/tango-dependencies/**/*

build_tango-db:
  retry: 2
  stage: build_1
  variables:
    IMAGE_FOLDER: tango/tango-db
  tags:
  - k8srunner
  script:
  - *build_push
  only:
    changes:
    - docker/tango/tango-db/**/*

build_tango-cpp:
  retry: 2
  stage: build_2
  variables:
    IMAGE_FOLDER: tango/tango-cpp
  tags:
  - k8srunner
  script:
  - *build_push
  only:
    changes:
    - docker/tango/tango-dependencies/**/*
    - docker/tango/tango-cpp/**/*

build_tango-cpp-alpine:
  retry: 2
  stage: build_2
  variables:
    IMAGE_FOLDER: tango/tango-cpp-alpine
  tags:
  - k8srunner
  script:
  - *build_push
  only:
    changes:
    - docker/tango/tango-cpp-alpine/**/*


build_tango-java:
  retry: 2
  stage: build_2
  variables:
    IMAGE_FOLDER: tango/tango-java
  tags:
  - k8srunner
  script:
  - *build_push
  only:
    changes:
    - docker/tango/tango-dependencies/**/*
    - docker/tango/tango-java/**/*

build_tango-rest:
  retry: 2
  stage: build_3
  variables:
    IMAGE_FOLDER: tango/tango-rest
  tags:
  - k8srunner
  script:
  - *build_push
  only:
    changes:
    - docker/tango/tango-dependencies/**/*
    - docker/tango/tango-cpp/**/*
    - docker/tango/tango-rest/**/*

build_pytango-builder:
  retry: 2
  stage: build_3
  variables:
    IMAGE_FOLDER: tango/pytango-builder
  tags:
    - k8srunner
  script:
    - *build_push
  only:
    changes:
      - docker/tango/tango-dependencies/**/*
      - docker/tango/tango-cpp/**/*
      - docker/tango/pytango-builder/**/*

build_pytango-builder-alpine:
  retry: 2
  stage: build_3
  variables:
    IMAGE_FOLDER: tango/pytango-builder-alpine
  tags:
    - k8srunner
  script:
    - *build_push
  only:
    changes:
      - docker/tango/tango-cpp-alpine/**/*
      - docker/tango/pytango-builder-alpine/**/*


build_tango-pogo:
  retry: 2
  stage: build_3
  variables:
    IMAGE_FOLDER: tango/tango-pogo
  tags:
  - k8srunner
  script:
  - *build_push
  only:
    changes:
    - docker/tango/tango-dependencies/**/*
    - docker/tango/tango-java/**/*
    - docker/tango/tango-pogo/**/*

build_tango-libtango:
  retry: 2
  stage: build_3
  variables:
    IMAGE_FOLDER: tango/tango-libtango
  tags:
  - k8srunner
  script:
  - *build_push
  only:
    changes:
    - docker/tango/tango-dependencies/**/*
    - docker/tango/tango-cpp/**/*
    - docker/tango/tango-libtango/**/*

build_tango-jive:
  retry: 2
  stage: build_3
  variables:
    IMAGE_FOLDER: tango/tango-jive
  tags:
  - k8srunner
  script:
  - *build_push
  only:
    changes:
    - docker/tango/tango-dependencies/**/*
    - docker/tango/tango-java/**/*
    - docker/tango/tango-jive/**/*

build_pytango-runtime:
  retry: 2
  stage: build_4
  variables:
    IMAGE_FOLDER: tango/pytango-runtime
  tags:
  - k8srunner
  script:
  - *build_push
  only:
    changes:
    - docker/tango/tango-dependencies/**/*
    - docker/tango/tango-cpp/**/*
    - docker/tango/pytango-builder/**/*
    - docker/tango/pytango-runtime/**/*

build_pytango-runtime-alpine:
  retry: 2
  stage: build_4
  variables:
    IMAGE_FOLDER: tango/pytango-runtime-alpine
  tags:
  - k8srunner
  script:
  - *build_push
  only:
    changes:
    - docker/tango/tango-cpp-alpine/**/*
    - docker/tango/pytango-builder-alpine/**/*
    - docker/tango/pytango-runtime-alpine/**/*

build_tango-admin:
  retry: 2
  stage: build_4
  variables:
    IMAGE_FOLDER: tango/tango-admin
  tags:
  - k8srunner
  script:
  - *build_push
  only:
    changes:
    - docker/tango/tango-dependencies/**/*
    - docker/tango/tango-cpp/**/*
    - docker/tango/tango-libtango/**/*
    - docker/tango/tango-admin/**/*

build_tango-databaseds:
  retry: 2
  stage: build_4
  variables:
    IMAGE_FOLDER: tango/tango-databaseds
  tags:
  - k8srunner
  script:
  - *build_push
  only:
    changes:
    - docker/tango/tango-dependencies/**/*
    - docker/tango/tango-cpp/**/*
    - docker/tango/tango-libtango/**/*
    - docker/tango/tango-databaseds/**/*

build_tango-test:
  retry: 2
  stage: build_4
  variables:
    IMAGE_FOLDER: tango/tango-test
  tags:
  - k8srunner
  script:
  - *build_push
  only:
    changes:
    - docker/tango/tango-dependencies/**/*
    - docker/tango/tango-cpp/**/*
    - docker/tango/tango-libtango/**/*
    - docker/tango/tango-test/**/*

build_tango-dsconfig:
  retry: 2
  stage: build_5
  variables:
    IMAGE_FOLDER: tango/tango-dsconfig
  tags:
  - k8srunner
  script:
  - *build_push
  only:
    changes:
    - docker/tango/tango-dependencies/**/*
    - docker/tango/tango-cpp/**/*
    - docker/tango/pytango-builder/**/*
    - docker/tango/pytango-runtime/**/*
    - docker/tango/tango-dsconfig/**/*

build_tango-itango:
  retry: 2
  stage: build_5
  variables:
    IMAGE_FOLDER: tango/tango-itango
  tags:
  - k8srunner
  script:
  - *build_push
  only:
    changes:
    - docker/tango/tango-dependencies/**/*
    - docker/tango/tango-cpp/**/*
    - docker/tango/pytango-builder/**/*
    - docker/tango/pytango-runtime/**/*
    - docker/tango/tango-itango/**/*

build_tango-vnc:
  retry: 2
  stage: build_5
  variables:
    IMAGE_FOLDER: tango/tango-vnc
  tags:
  - k8srunner
  script:
  - *build_push
  only:
    changes:
    - docker/tango/tango-dependencies/**/*
    - docker/tango/tango-java/**/*
    - docker/tango/tango-vnc/**/*

build_tango-pytango:
  retry: 2
  stage: build_5
  variables:
    IMAGE_FOLDER: tango/tango-pytango
  tags:
  - k8srunner
  script:
  - *build_push
  only:
    changes:
    - docker/tango/tango-dependencies/**/*
    - docker/tango/tango-cpp/**/*
    - docker/tango/pytango-builder/**/*
    - docker/tango/pytango-runtime/**/*
    - docker/tango/tango-pytango/**/*

build_tango-panic:
  retry: 2
  stage: build_5
  variables:
    IMAGE_FOLDER: tango/tango-panic
  tags:
  - k8srunner
  script:
  - *build_push
  only:
    changes:
    - docker/tango/tango-panic/**/*
    - docker/tango/tango-dependencies/**/*
    - docker/tango/tango-cpp/**/*
    - docker/tango/pytango-builder/**/*
    - docker/tango/pytango-runtime/**/*
    - docker/tango/tango-pytango/**/*

build_tango-panic-gui:
  retry: 2
  stage: build_5
  variables:
    IMAGE_FOLDER: tango/tango-panic-gui
  tags:
  - k8srunner
  script:
  - *build_push
  only:
    changes:
    - docker/tango/tango-panic-gui/**/*
    - docker/tango/tango-dependencies/**/*
    - docker/tango/tango-cpp/**/*
    - docker/tango/pytango-builder/**/*
    - docker/tango/pytango-runtime/**/*
    - docker/tango/tango-pytango/**/*

# test-chart:
#   stage: test
#   variables:
#     MINIKUBE: "false"
#   tags:
#   - k8srunner
#   image: $SKA_K8S_TOOLS_DEPLOY_IMAGE
#   script:
#   - cd charts/
#   - kubectl version
#   - helm version
#   - make install-chart
#   - make wait
#   - make test
#   - make chart_lint
#   - mkdir -p ../build/reports
#   - mv build/report.xml ../build/reports/unit-tests.xml
#   - mv build/linting.xml ../build/reports/linting.xml
#   after_script:
#   - cd charts/
#   - make uninstall-chart
#   - make delete_namespace
#   environment:
#     name: test
#     kubernetes:
#       namespace: ci-$CI_PROJECT_NAME-$CI_COMMIT_SHORT_SHA
#   artifacts:
#     name: "$CI_PROJECT_NAME-$CI_JOB_ID"
#     paths:
#       - "build/"
#     reports:
#       junit: build/reports/unit-tests.xml

variables:
    CHARTS_TO_PUBLISH: ska-tango-util ska-tango-base
# Ensure your .gitlab-ci.yml has "publish" stage defined!
include:
  # - project: 'ska-telescope/templates-repository'
  #   file: 'gitlab-ci/includes/helm_publish.yml'
    
  - project: 'ska-telescope/templates-repository'
    file: 'gitlab-ci/includes/raw-publish.gitlab-ci.yml'
    ref: st-933-publish-raw-packages

# Create Gitlab CI badges from CI metrics
# https://developer.skatelescope.org/en/latest/tools/continuousintegration.html#automated-collection-of-ci-health-metrics-as-part-of-the-ci-pipeline


