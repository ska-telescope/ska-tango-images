image: $SKA_K8S_TOOLS_DOCKER_BUILDER_IMAGE

variables:
  GIT_SUBMODULE_STRATEGY: recursive

stages:
- lint
- build
# - build_0
- build_1
- build_2
- build_3
- build_4
- build_5
# - push
- test
- publish
- pages
- cleanup_build

# https://docs.gitlab.com/ee/ci/docker/using_docker_build.html#authenticating-to-the-container-registry
before_script:
  - echo $CAR_OCI_REGISTRY_PASSWORD | docker login -u $CAR_OCI_REGISTRY_USERNAME --password-stdin $CAR_OCI_REGISTRY_HOST

.image_builder_template:
  image: $SKA_K8S_TOOLS_DEPLOY_IMAGE
  retry: 2
  tags:
    - k8srunner
  before_script:
    - '[ -f .make/oci.mk ] || exit 1'
    - 'make help | grep oci.mk:oci-build'
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
    - echo $CAR_OCI_REGISTRY_PASSWORD | docker login -u $CAR_OCI_REGISTRY_USERNAME --password-stdin $CAR_OCI_REGISTRY_HOST
  script:
    - |
      if [[ -n "${BUILD_IMAGE}" ]]; then
        IMG="${BUILD_IMAGE##*/}";
        VERS=$(make show-version RELEASE_CONTEXT_DIR=images/);
        export BUILD_IMAGE="${BUILD_IMAGE}:${VERS}";
      fi;
      if [[ -n "${BASE_IMAGE}" ]]; then
        IMG="${BASE_IMAGE##*/}";
        VERS=$(make show-version RELEASE_CONTEXT_DIR=images/);
        export BASE_IMAGE="${BASE_IMAGE}:${VERS}";
      fi;
    - make oci-build OCI_IMAGE=${OCI_IMAGE} CAR_OCI_REGISTRY_HOST=${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME} RELEASE_CONTEXT_DIR=images/${OCI_IMAGE} OCI_BUILD_ADDITIONAL_ARGS=" --build-arg BUILD_IMAGE --build-arg BASE_IMAGE "

build_dependencies:
  stage: build_1
  extends:
    - .image_builder_template
  variables:
    OCI_IMAGE: ska-tango-images-tango-dependencies
  only:
    changes:
    - images/ska-tango-images-tango-dependencies/*

build_dependencies-alpine:
  retry: 2
  stage: build_1
  extends:
  - .image_builder_template
  variables:
    OCI_IMAGE: ska-tango-images-tango-dependencies-alpine
  only:
    changes:
    - images/ska-tango-images-tango-dependencies-alpine/*

build_tango-db:
  retry: 2
  stage: build_1
  extends:
  - .image_builder_template
  variables:
    OCI_IMAGE: ska-tango-images-tango-db
  only:
    changes:
    - images/ska-tango-images-tango-db/*

build_tango-db-alpine:
  retry: 2
  stage: build_1
  extends:
  - .image_builder_template
  variables:
    OCI_IMAGE: ska-tango-images-tango-db-alpine
  only:
    changes:
    - images/ska-tango-images-tango-db-alpine/*

build_tango-cpp:
  retry: 2
  stage: build_2
  extends:
  - .image_builder_template
  variables:
    OCI_IMAGE: ska-tango-images-tango-cpp
    BUILD_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-tango-dependencies
  only:
    changes:
    - images/ska-tango-images-tango-dependencies/*
    - images/ska-tango-images-tango-cpp/*

build_tango-cpp-alpine:
  retry: 2
  stage: build_2
  extends:
  - .image_builder_template
  variables:
    OCI_IMAGE: ska-tango-images-tango-cpp-alpine
    BUILD_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-tango-dependencies-alpine:0.2.1
  only:
    changes:
    - images/ska-tango-images-tango-dependencies-alpine/*
    - images/ska-tango-images-tango-cpp-alpine/*


build_tango-java:
  retry: 2
  stage: build_2
  extends:
  - .image_builder_template
  variables:
    OCI_IMAGE: ska-tango-images-tango-java
    BUILD_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-tango-dependencies
  only:
    changes:
    - images/ska-tango-images-tango-dependencies/*
    - images/ska-tango-images-tango-java/*

build_tango-rest:
  retry: 2
  stage: build_3
  extends:
  - .image_builder_template
  variables:
    OCI_IMAGE: ska-tango-images-tango-rest
    BASE_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-tango-java
    BUILD_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-tango-dependencies
  only:
    changes:
    - images/ska-tango-images-tango-dependencies/*
    - images/ska-tango-images-tango-cpp/*
    - images/ska-tango-images-tango-rest/*

build_pytango-builder:
  retry: 2
  stage: build_3
  extends:
  - .image_builder_template
  variables:
    OCI_IMAGE: ska-tango-images-pytango-builder
    BASE_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-tango-cpp
  only:
    changes:
      - images/ska-tango-images-tango-dependencies/*
      - images/ska-tango-images-tango-cpp/*
      - images/ska-tango-images-pytango-builder/*

build_pytango-builder-alpine:
  retry: 2
  stage: build_3
  extends:
  - .image_builder_template
  variables:
    OCI_IMAGE: ska-tango-images-pytango-builder-alpine
    BASE_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-tango-cpp-alpine
  only:
    changes:
      - images/ska-tango-images-tango-cpp-alpine/*
      - images/ska-tango-images-pytango-builder-alpine/*


build_tango-pogo:
  retry: 2
  stage: build_3
  extends:
  - .image_builder_template
  variables:
    OCI_IMAGE: ska-tango-images-tango-pogo
    BASE_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-tango-java
  only:
    changes:
    - images/ska-tango-images-tango-dependencies/*
    - images/ska-tango-images-tango-java/*
    - images/ska-tango-images-tango-pogo/*

build_tango-libtango:
  retry: 2
  stage: build_3
  extends:
  - .image_builder_template
  variables:
    OCI_IMAGE: ska-tango-images-tango-libtango
    BASE_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-tango-cpp
  only:
    changes:
    - images/ska-tango-images-tango-dependencies/*
    - images/ska-tango-images-tango-cpp/*
    - images/ska-tango-images-tango-libtango/*

build_tango-jive:
  retry: 2
  stage: build_3
  extends:
  - .image_builder_template
  variables:
    OCI_IMAGE: ska-tango-images-tango-jive
    BASE_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-tango-java
  only:
    changes:
    - images/ska-tango-images-tango-dependencies/*
    - images/ska-tango-images-tango-java/*
    - images/ska-tango-images-tango-jive/*

build_pytango-runtime:
  retry: 2
  stage: build_4
  extends:
  - .image_builder_template
  variables:
    OCI_IMAGE: ska-tango-images-pytango-runtime
    BASE_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-tango-cpp
    BUILD_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-pytango-builder
  only:
    changes:
    - images/ska-tango-images-tango-dependencies/*
    - images/ska-tango-images-tango-cpp/*
    - images/ska-tango-images-pytango-builder/*
    - images/ska-tango-images-pytango-runtime/*


build_pytango-runtime-alpine:
  retry: 2
  stage: build_4
  extends:
  - .image_builder_template
  variables:
    OCI_IMAGE: ska-tango-images-pytango-runtime-alpine
    BASE_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-tango-cpp-alpine
    BUILD_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-pytango-builder-alpine
  only:
    changes:
    - images/ska-tango-images-tango-cpp-alpine/*
    - images/ska-tango-images-pytango-builder-alpine/*
    - images/ska-tango-images-pytango-runtime-alpine/*

build_tango-admin:
  retry: 2
  stage: build_4
  extends:
  - .image_builder_template
  variables:
    OCI_IMAGE: ska-tango-images-tango-admin
    BASE_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-tango-libtango
  only:
    changes:
    - images/ska-tango-images-tango-dependencies/*
    - images/ska-tango-images-tango-cpp/*
    - images/ska-tango-images-tango-libtango/*
    - images/ska-tango-images-tango-admin/*

build_tango-databaseds:
  retry: 2
  stage: build_4
  extends:
  - .image_builder_template
  variables:
    OCI_IMAGE: ska-tango-images-tango-databaseds
    BASE_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-tango-libtango
  only:
    changes:
    - images/ska-tango-images-tango-dependencies/*
    - images/ska-tango-images-tango-cpp/*
    - images/ska-tango-images-tango-libtango/*
    - images/ska-tango-images-tango-databaseds/*

build_tango-test:
  retry: 2
  stage: build_4
  extends:
  - .image_builder_template
  variables:
    OCI_IMAGE: ska-tango-images-tango-test
    BASE_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-tango-libtango
  only:
    changes:
    - images/ska-tango-images-tango-dependencies/*
    - images/ska-tango-images-tango-cpp/*
    - images/ska-tango-images-tango-libtango/*
    - images/ska-tango-images-tango-test/*

build_tango-dsconfig:
  retry: 2
  stage: build_5
  extends:
  - .image_builder_template
  variables:
    OCI_IMAGE: ska-tango-images-tango-dsconfig
    BUILD_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-pytango-builder
    BASE_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-pytango-runtime
  only:
    changes:
    - images/ska-tango-images-tango-dependencies/*
    - images/ska-tango-images-tango-cpp/*
    - images/ska-tango-images-pytango-builder/*
    - images/ska-tango-images-pytango-runtime/*
    - images/ska-tango-images-tango-dsconfig/*

build_tango-dsconfig-alpine:
  retry: 2
  stage: build_5
  extends:
  - .image_builder_template
  variables:
    OCI_IMAGE: ska-tango-images-tango-dsconfig-alpine
    BUILD_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-pytango-builder-alpine
    BASE_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-pytango-runtime-alpine
  only:
    changes:
    - images/ska-tango-images-pytango-builder-alpine/*
    - images/ska-tango-images-pytango-runtime-alpine/*
    - images/ska-tango-images-tango-dsconfig-alpine/*

build_tango-itango:
  retry: 2
  stage: build_5
  extends:
  - .image_builder_template
  variables:
    OCI_IMAGE: ska-tango-images-tango-itango
    BUILD_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-pytango-builder
    BASE_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-pytango-runtime
  only:
    changes:
    - images/ska-tango-images-tango-dependencies/*
    - images/ska-tango-images-tango-cpp/*
    - images/ska-tango-images-pytango-builder/*
    - images/ska-tango-images-pytango-runtime/*
    - images/ska-tango-images-tango-itango/*

build_tango-itango-alpine:
  retry: 2
  stage: build_5
  extends:
  - .image_builder_template
  variables:
    OCI_IMAGE: ska-tango-images-tango-itango-alpine
    BUILD_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-pytango-builder-alpine
    BASE_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-pytango-runtime-alpine
  only:
    changes:
    - images/ska-tango-images-pytango-builder-alpine/*
    - images/ska-tango-images-pytango-runtime-alpine/*
    - images/ska-tango-images-tango-itango-alpine/*

build_tango-vnc:
  retry: 2
  stage: build_5
  extends:
  - .image_builder_template
  variables:
    OCI_IMAGE: ska-tango-images-tango-vnc
    BASE_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-tango-java
  only:
    changes:
    - images/ska-tango-images-tango-dependencies/*
    - images/ska-tango-images-tango-java/*
    - images/ska-tango-images-tango-vnc/*

build_tango-pytango:
  retry: 2
  stage: build_5
  extends:
  - .image_builder_template
  variables:
    OCI_IMAGE: ska-tango-images-tango-pytango
    BUILD_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-pytango-builder
    BASE_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-pytango-runtime
  # only:
  #   changes:
  #   - images/ska-tango-images-tango-dependencies/*
  #   - images/ska-tango-images-tango-cpp/*
  #   - images/ska-tango-images-pytango-builder/*
  #   - images/ska-tango-images-pytango-runtime/*
  #   - images/ska-tango-images-tango-pytango/*

build_tango-pytango-alpine:
  retry: 2
  stage: build_5
  extends:
  - .image_builder_template
  variables:
    OCI_IMAGE: ska-tango-images-tango-pytango-alpine
    BUILD_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-pytango-builder-alpine
    BASE_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-pytango-runtime-alpine
  # only:
  #   changes:
  #   - images/ska-tango-images-pytango-builder-alpine/*
  #   - images/ska-tango-images-tango-pytango-alpine/*

build_tango-panic:
  retry: 2
  stage: build_5
  extends:
  - .image_builder_template
  variables:
    OCI_IMAGE: ska-tango-images-tango-panic
    BASE_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-pytango-builder
  # only:
  #   changes:
  #   - images/ska-tango-images-tango-panic/*
  #   - images/ska-tango-images-tango-dependencies/*
  #   - images/ska-tango-images-tango-cpp/*
  #   - images/ska-tango-images-pytango-builder/*
  #   - images/ska-tango-images-pytango-runtime/*
  #   - images/ska-tango-images-tango-pytango/*

build_tango-panic-gui:
  retry: 2
  stage: build_5
  extends:
  - .image_builder_template
  variables:
    OCI_IMAGE: ska-tango-images-tango-panic-gui
    BASE_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-pytango-builder
  # only:
  #   changes:
  #   - images/ska-tango-images-tango-panic-gui/*
  #   - images/ska-tango-images-tango-dependencies/*
  #   - images/ska-tango-images-tango-cpp/*
  #   - images/ska-tango-images-pytango-builder/*
  #   - images/ska-tango-images-pytango-runtime/*
  #   - images/ska-tango-images-tango-pytango/*

# test-chart:
#   stage: test
#   variables:
#     MINIKUBE: "false"
#   tags:
#   - k8srunner
#   image: $SKA_K8S_TOOLS_DEPLOY_IMAGE
#   script:
#   - cd charts/
#   - kubectl version
#   - helm version
#   - make install-chart
#   - make wait
#   - make test
#   - make chart_lint
#   - mkdir -p ../build/reports
#   - mv build/report.xml ../build/reports/unit-tests.xml
#   - mv build/linting.xml ../build/reports/linting.xml
#   after_script:
#   - cd charts/
#   - make uninstall-chart
#   - make delete_namespace
#   environment:
#     name: test
#     kubernetes:
#       namespace: ci-$CI_PROJECT_NAME-$CI_COMMIT_SHORT_SHA
#   artifacts:
#     name: "$CI_PROJECT_NAME-$CI_JOB_ID"
#     paths:
#       - "build/"
#     reports:
#       junit: build/reports/unit-tests.xml









#############################################################
#############################################################
#############################################################
#############################################################
# # Ensure your .gitlab-ci.yml has "publish" stage defined!
# include:
#   - project: 'ska-telescope/templates-repository'
#     file: 'gitlab-ci/includes/helm_publish.yml'

# # Create Gitlab CI badges from CI metrics
# # https://developer.skatelescope.org/en/latest/tools/continuousintegration.html#automated-collection-of-ci-health-metrics-as-part-of-the-ci-pipeline
#   - project: 'ska-telescope/templates-repository'
#     file: 'gitlab-ci/includes/post_step.yml'


# Include CI templates
include:
# OCI Images
  # # do a custom set of build stages
  # - project: 'ska-telescope/templates-repository'
  #   file: 'gitlab-ci/includes/oci-image-lint.gitlab-ci.yml'
  # # - project: 'ska-telescope/templates-repository'
  # #   file: 'gitlab-ci/includes/oci-image-publish.gitlab-ci.yml'

# # Helm Charts
#   - project: 'ska-telescope/templates-repository'
#     file: 'gitlab-ci/includes/helm-chart.gitlab-ci.yml'

# Docs pages
  - project: 'ska-telescope/templates-repository'
    file: 'gitlab-ci/includes/docs-pages.gitlab-ci.yml'
    # ref: master

# .post step finalisers eg: badges
  - project: 'ska-telescope/templates-repository'
    file: 'gitlab-ci/includes/finaliser.gitlab-ci.yml'

# # override variables
# helm-chart-publish:
#   variables:
#       HELM_CHARTS_TO_PUBLISH: ska-tango-util ska-tango-base
