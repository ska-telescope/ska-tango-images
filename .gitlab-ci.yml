image: $SKA_K8S_TOOLS_DOCKER_BUILDER_IMAGE

variables:
  GIT_SUBMODULE_STRATEGY: recursive
  OCI_BUILD_ADDITIONAL_TAGS: $CI_COMMIT_SHORT_SHA
  FORCE_REBUILD: "yes"

stages:
- lint
- build
- build_1
- build_2
- build_3
- build_4
- build_5
- test
- publish
- scan
- pages
- cleanup_build

# https://docs.gitlab.com/ee/ci/docker/using_docker_build.html#authenticating-to-the-container-registry
before_script:
  - echo $CAR_OCI_REGISTRY_PASSWORD | docker login -u $CAR_OCI_REGISTRY_USERNAME --password-stdin $CAR_OCI_REGISTRY_HOST

.image_builder_template:
  image: $SKA_K8S_TOOLS_DEPLOY_IMAGE
  retry: 2
  tags:
    - aws-k8srunner
  before_script:
    - '[ -f .make/oci.mk ] || exit 1'
    - 'make help | grep oci-build'
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
    - echo $CAR_OCI_REGISTRY_PASSWORD | docker login -u $CAR_OCI_REGISTRY_USERNAME --password-stdin $CAR_OCI_REGISTRY_HOST
  script:
    - echo "Incoming BUILD_IMAGE=${BUILD_IMAGE} BASE_IMAGE=${BASE_IMAGE}"
    - |
      if [[ -n "${BUILD_IMAGE}" ]]; then
        IMG="${BUILD_IMAGE##*/}";
        VERS=$(make show-version RELEASE_CONTEXT_DIR=images/${IMG});
        export BUILD_IMAGE="${BUILD_IMAGE}:${VERS}";
      fi;
      if [[ -n "${BASE_IMAGE}" ]]; then
        IMG="${BASE_IMAGE##*/}";
        VERS=$(make show-version RELEASE_CONTEXT_DIR=images/${IMG});
        export BASE_IMAGE="${BASE_IMAGE}:${VERS}";
      fi;
    - echo "Image dependencies set to BUILD_IMAGE=${BUILD_IMAGE} BASE_IMAGE=${BASE_IMAGE}"
    - |
      echo "Check/pulling ${OCI_IMAGE} image to build:";
      export VERS=$(make show-version RELEASE_CONTEXT_DIR=images/${OCI_IMAGE});
      export IMG=${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/${OCI_IMAGE}:${VERS};
      echo "Image to build: ${IMG}"; docker pull ${IMG} || true;
    - make oci-build OCI_IMAGE=${OCI_IMAGE} CAR_OCI_REGISTRY_HOST=${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME} RELEASE_CONTEXT_DIR=images/${OCI_IMAGE} OCI_BUILD_ADDITIONAL_ARGS="--no-cache --build-arg BUILD_IMAGE --build-arg BASE_IMAGE "

# if no build is done, this job does not work
# for the moment we keep it as disabled
.ska-tango-examples-tests-use-trigger:
  variables:
    BUILD_IMAGE: "${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-pytango-builder:$CI_COMMIT_SHORT_SHA"
    BASE_IMAGE: "${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-pytango-runtime:$CI_COMMIT_SHORT_SHA"
    OCI_BUILD_ADDITIONAL_ARGS: "--no-cache --build-arg BUILD_IMAGE --build-arg BASE_IMAGE "
    SKA_PYTHON_PYTANGO_BUILDER_IMAGE: "${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-pytango-builder:$CI_COMMIT_SHORT_SHA"
    PYTANGO_VERSION: "9.3.6"
  trigger:
    project: ska-telescope/ska-tango-examples
    strategy: depend

ska-tango-examples-tests:
  allow_failure: true
  stage: test
  tags:
    - aws-k8srunner
  script:
    - |
      VERS=$(make show-version RELEASE_CONTEXT_DIR=images/ska-tango-images-pytango-builder)
      export BUILD_IMAGE="${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-pytango-builder:${VERS}"
      VERS=$(make show-version RELEASE_CONTEXT_DIR=images/ska-tango-images-pytango-runtime)
      export BASE_IMAGE="${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-pytango-runtime:${VERS}"
      export OCI_BUILD_ADDITIONAL_ARGS="--no-cache --build-arg BUILD_IMAGE --build-arg BASE_IMAGE "
      export PYTANGO_VERSION="$(docker run ${BUILD_IMAGE} pip list | grep pytango | awk '{print $2}')"
      response=$(curl --request POST \
           --form token=$CI_JOB_TOKEN \
           --form ref=master \
           --form "variables[BUILD_IMAGE]=${BUILD_IMAGE}" \
           --form "variables[PYTANGO_VERSION]=${PYTANGO_VERSION}" \
           --form "variables[BASE_IMAGE]=${BASE_IMAGE}" \
           --form "variables[OCI_BUILD_ADDITIONAL_ARGS]=${OCI_BUILD_ADDITIONAL_ARGS}" \
           --form "variables[SKA_PYTHON_PYTANGO_BUILDER_IMAGE]=${BUILD_IMAGE}" \
           "https://gitlab.com/api/v4/projects/9673989/trigger/pipeline")
      echo "Created pipeline for 'ska-tango-examples': $(jq -r '.web_url' <<< "$response")"
      pipeline_id=$(jq -r '.id' <<< "$response")
      pipeline_url="https://gitlab.com/api/v4/projects/9673989/pipelines/${pipeline_id}"
      jobs_url="$pipeline_url/jobs?per_page=100"
      for i in {1..800}
      do
        response=$(curl -s --header "PRIVATE-TOKEN: $GITLAB_TOKEN" "$pipeline_url")
        status=$(jq -r '.status' <<< "$response" || true) 
        if [[ $status == "running" ]]; then
          response=$(curl -s --header "PRIVATE-TOKEN: $GITLAB_TOKEN" "$jobs_url")
          k8steststatus=$(jq -r '.[] | select(.name == "k8s-test") | .status' <<< $response)
          pythonteststatus=$(jq -r '.[] | select(.name == "python-test") | .status' <<< $response)
          if [[ $k8steststatus  == "success" ]] && [[ $pythonteststatus  == "success" ]]; then
            echo "'ska-tango-examples' success."
            exit 0
          elif [[ $k8steststatus  == "failed" ]] || [[ $pythonteststatus  == "failed" ]]; then
            echo "'ska-tango-examples' failed."
            exit 1
          elif [[ $k8steststatus  == "canceled" ]] || [[ $pythonteststatus  == "canceled" ]]; then
            echo "'ska-tango-examples' canceled."
            exit 1
          else
            echo -n '.'
            sleep 5
          fi
        elif [[ $status == "failed" ]]; then
          echo "'ska-tango-examples' failed."
          exit 1
        elif [[ $status == "canceled" ]]; then
          echo "'ska-tango-examples' canceled."
          exit 1
        else
          echo -n '.'
          sleep 5
        fi
      done

.tango-dependencies_rules:
  rules:
    - if: '$CI_COMMIT_TAG'
    - if: '$FORCE_REBUILD == "yes" || $FORCE_REBUILD == "build_1"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH' ## To eliminate duplicate detached MRs and not on merge to master
      changes:
      - images/ska-tango-images-tango-dependencies/*

build_tango-dependencies:
  stage: build_1
  extends:
    - .image_builder_template
  variables:
    OCI_IMAGE: ska-tango-images-tango-dependencies
  rules:
    - !reference [.tango-dependencies_rules, rules]

.build_tango-db-rules:
  rules:
    - if: '$CI_COMMIT_TAG'
    - if: '$FORCE_REBUILD == "yes" || $FORCE_REBUILD == "build_1"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH'
      changes:
      - images/ska-tango-images-tango-db/*

build_tango-db: 
  retry: 2
  stage: build_1
  extends:
  - .image_builder_template
  variables:
    OCI_IMAGE: ska-tango-images-tango-db
  rules:
    - !reference [.build_tango-db-rules, rules]

.tango-cpp-rules:
  rules:
    - if: '$CI_COMMIT_TAG'
    - if: '$FORCE_REBUILD == "yes" || $FORCE_REBUILD == "build_2"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH'
      changes:
      - images/ska-tango-images-tango-dependencies/*
      - images/ska-tango-images-tango-cpp/*

build_tango-cpp: 
  retry: 2
  stage: build_2
  extends:
  - .image_builder_template
  variables:
    OCI_IMAGE: ska-tango-images-tango-cpp
    BUILD_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-tango-dependencies
  rules:
    - !reference [.tango-cpp-rules, rules]

.tango-java-rules:
  rules:
    - if: '$CI_COMMIT_TAG'
    - if: '$FORCE_REBUILD == "yes" || $FORCE_REBUILD == "build_2"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH'
      changes:
      - images/ska-tango-images-tango-dependencies/*
      - images/ska-tango-images-tango-java/*

build_tango-java: 
  retry: 2
  stage: build_2
  extends:
  - .image_builder_template
  variables:
    OCI_IMAGE: ska-tango-images-tango-java
    BUILD_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-tango-dependencies
  rules:
    - !reference [.tango-java-rules, rules]

.tango-rest-rules:
  rules:
    - if: '$CI_COMMIT_TAG'
    - if: '$FORCE_REBUILD == "yes" || $FORCE_REBUILD == "build_3"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH'
      changes:
      - images/ska-tango-images-tango-dependencies/*
      - images/ska-tango-images-tango-java/*
      - images/ska-tango-images-tango-rest/*

build_tango-rest:
  retry: 2
  stage: build_3
  extends:
  - .image_builder_template
  variables:
    OCI_IMAGE: ska-tango-images-tango-rest
    BASE_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-tango-java
    BUILD_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-tango-dependencies
  rules:
    - !reference [.tango-rest-rules, rules]

.pytango-builder-rules:
  rules:
    - if: '$CI_COMMIT_TAG'
    - if: '$FORCE_REBUILD == "yes" || $FORCE_REBUILD == "build_3"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH'
      changes:
      - images/ska-tango-images-tango-dependencies/*
      - images/ska-tango-images-tango-cpp/*
      - images/ska-tango-images-pytango-builder/*

build_pytango-builder:
  retry: 2
  stage: build_3
  extends:
  - .image_builder_template
  variables:
    OCI_IMAGE: ska-tango-images-pytango-builder
    BASE_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-tango-cpp
  rules:
    - !reference [.pytango-builder-rules, rules]

.tango-pogo-rules:
  rules:
    - if: '$CI_COMMIT_TAG'
    - if: '$FORCE_REBUILD == "yes" || $FORCE_REBUILD == "build_3"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH'
      changes:
      - images/ska-tango-images-tango-dependencies/*
      - images/ska-tango-images-tango-java/*
      - images/ska-tango-images-tango-pogo/*

build_tango-pogo:
  retry: 2
  stage: build_3
  extends:
  - .image_builder_template
  variables:
    OCI_IMAGE: ska-tango-images-tango-pogo
    BASE_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-tango-java
  rules:
    - !reference [.tango-pogo-rules, rules]

.tango-libtango-rules:
  rules:
    - if: '$CI_COMMIT_TAG'
    - if: '$FORCE_REBUILD == "yes" || $FORCE_REBUILD == "build_3"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH'
      changes:
      - images/ska-tango-images-tango-dependencies/*
      - images/ska-tango-images-tango-cpp/*
      - images/ska-tango-images-tango-libtango/*

build_tango-libtango:
  retry: 2
  stage: build_3
  extends:
  - .image_builder_template
  variables:
    OCI_IMAGE: ska-tango-images-tango-libtango
    BASE_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-tango-cpp
  rules:
    - !reference [.tango-libtango-rules, rules]

.tango-jive-rules:
  rules:
    - if: '$CI_COMMIT_TAG'
    - if: '$FORCE_REBUILD == "yes" || $FORCE_REBUILD == "build_3"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH'
      changes:
      - images/ska-tango-images-tango-dependencies/*
      - images/ska-tango-images-tango-java/*
      - images/ska-tango-images-tango-jive/*

build_tango-jive:
  retry: 2
  stage: build_3
  extends:
  - .image_builder_template
  variables:
    OCI_IMAGE: ska-tango-images-tango-jive
    BASE_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-tango-java
  rules:
    - !reference [.tango-jive-rules, rules]

.pytango-runtime-rules:
  rules:
    - if: '$CI_COMMIT_TAG'
    - if: '$FORCE_REBUILD == "yes"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" || $FORCE_REBUILD == "build_4"'
      changes:
      - images/ska-tango-images-tango-dependencies/*
      - images/ska-tango-images-tango-cpp/*
      - images/ska-tango-images-pytango-builder/*
      - images/ska-tango-images-pytango-runtime/*

build_pytango-runtime:
  retry: 2
  stage: build_4
  extends:
  - .image_builder_template
  variables:
    OCI_IMAGE: ska-tango-images-pytango-runtime
    BASE_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-tango-cpp
    BUILD_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-pytango-builder
  rules:
    - !reference [.pytango-runtime-rules, rules]

.tango-admin-rules:
  rules:
    - if: '$CI_COMMIT_TAG'
    - if: '$FORCE_REBUILD == "yes" || $FORCE_REBUILD == "build_4"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH'
      changes:
      - images/ska-tango-images-tango-dependencies/*
      - images/ska-tango-images-tango-cpp/*
      - images/ska-tango-images-tango-libtango/*
      - images/ska-tango-images-tango-admin/*

build_tango-admin:
  retry: 2
  stage: build_4
  extends:
  - .image_builder_template
  variables:
    OCI_IMAGE: ska-tango-images-tango-admin
    BASE_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-tango-libtango
  rules:
    - !reference [.tango-admin-rules, rules]

.tango-databaseds-rules:
  rules:
    - if: '$CI_COMMIT_TAG'
    - if: '$FORCE_REBUILD == "yes" || $FORCE_REBUILD == "build_4"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH'
      changes:
      - images/ska-tango-images-tango-dependencies/*
      - images/ska-tango-images-tango-cpp/*
      - images/ska-tango-images-tango-libtango/*
      - images/ska-tango-images-tango-databaseds/*

build_tango-databaseds:
  retry: 2
  stage: build_4
  extends:
  - .image_builder_template
  variables:
    OCI_IMAGE: ska-tango-images-tango-databaseds
    BASE_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-tango-libtango
  rules:
    - !reference [.tango-databaseds-rules, rules]

.tango-test-rules:
  rules:
    - if: '$CI_COMMIT_TAG'
    - if: '$FORCE_REBUILD == "yes" || $FORCE_REBUILD == "build_4"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH'
      changes:
      - images/ska-tango-images-tango-dependencies/*
      - images/ska-tango-images-tango-cpp/*
      - images/ska-tango-images-tango-libtango/*
      - images/ska-tango-images-tango-test/*

build_tango-test:
  retry: 2
  stage: build_4
  extends:
  - .image_builder_template
  variables:
    OCI_IMAGE: ska-tango-images-tango-test
    BASE_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-tango-libtango
  rules:
    - !reference [.tango-test-rules, rules]

.tango-dsconfig-rules:
  rules:
    - if: '$CI_COMMIT_TAG'
    - if: '$FORCE_REBUILD == "yes" || $FORCE_REBUILD == "build_5"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH'
      changes:
      - images/ska-tango-images-tango-dependencies/*
      - images/ska-tango-images-tango-cpp/*
      - images/ska-tango-images-pytango-builder/*
      - images/ska-tango-images-pytango-runtime/*
      - images/ska-tango-images-tango-dsconfig/*

build_tango-dsconfig:
  retry: 2
  stage: build_5
  extends:
  - .image_builder_template
  variables:
    OCI_IMAGE: ska-tango-images-tango-dsconfig
    BUILD_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-pytango-builder
    BASE_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-pytango-runtime
  rules:
    - !reference [.tango-dsconfig-rules, rules]

.tango-itango-rules:
  rules:
    - if: '$CI_COMMIT_TAG'
    - if: '$FORCE_REBUILD == "yes" || $FORCE_REBUILD == "build_5"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH'
      changes:
      - images/ska-tango-images-tango-dependencies/*
      - images/ska-tango-images-tango-cpp/*
      - images/ska-tango-images-pytango-builder/*
      - images/ska-tango-images-pytango-runtime/*
      - images/ska-tango-images-tango-itango/*

build_tango-itango:
  retry: 2
  stage: build_5
  extends:
  - .image_builder_template
  variables:
    OCI_IMAGE: ska-tango-images-tango-itango
    BUILD_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-pytango-builder
    BASE_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-pytango-runtime
  rules:
    - !reference [.tango-itango-rules, rules]

.tango-vnc-rules:
  rules:
    - if: '$CI_COMMIT_TAG'
    - if: '$FORCE_REBUILD == "yes" || $FORCE_REBUILD == "build_5"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH'
      changes:
      - images/ska-tango-images-tango-dependencies/*
      - images/ska-tango-images-tango-java/*
      - images/ska-tango-images-tango-vnc/*

build_tango-vnc:
  retry: 2
  stage: build_5
  extends:
  - .image_builder_template
  variables:
    OCI_IMAGE: ska-tango-images-tango-vnc
    BASE_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-tango-java
  rules:
    - !reference [.tango-vnc-rules, rules]

.tango-pytango-rules:
  rules:
    - if: '$CI_COMMIT_TAG'
    - if: '$FORCE_REBUILD == "yes" || $FORCE_REBUILD == "build_5"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH'
      changes:
      - images/ska-tango-images-tango-dependencies/*
      - images/ska-tango-images-tango-cpp/*
      - images/ska-tango-images-pytango-builder/*
      - images/ska-tango-images-pytango-runtime/*
      - images/ska-tango-images-tango-pytango/*

build_tango-pytango:
  retry: 2
  stage: build_5
  extends:
  - .image_builder_template
  variables:
    OCI_IMAGE: ska-tango-images-tango-pytango
    BUILD_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-pytango-builder
    BASE_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-pytango-runtime
  rules:
    - !reference [.tango-pytango-rules, rules]

.tango-panic-rules:
  rules:
    - if: '$CI_COMMIT_TAG'
    - if: '$FORCE_REBUILD == "yes" || $FORCE_REBUILD == "build_5"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH'
      changes:
      - images/ska-tango-images-tango-panic/*
      - images/ska-tango-images-tango-dependencies/*
      - images/ska-tango-images-tango-cpp/*
      - images/ska-tango-images-pytango-builder/*
      - images/ska-tango-images-pytango-runtime/*
      - images/ska-tango-images-tango-pytango/*

.build_tango-panic:
  retry: 2
  stage: build_5
  extends:
  - .image_builder_template
  variables:
    OCI_IMAGE: ska-tango-images-tango-panic
    BASE_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-pytango-builder
  rules:
    - !reference [.tango-panic-rules, rules]

.tango-panic-gui-rules:
  rules:
    - if: '$CI_COMMIT_TAG'
    - if: '$FORCE_REBUILD == "yes" || $FORCE_REBUILD == "build_5"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH'
      changes:
      - images/ska-tango-images-tango-panic-gui/*
      - images/ska-tango-images-tango-dependencies/*
      - images/ska-tango-images-tango-cpp/*
      - images/ska-tango-images-pytango-builder/*
      - images/ska-tango-images-pytango-runtime/*
      - images/ska-tango-images-tango-pytango/*

.build_tango-panic-gui:
  retry: 2
  stage: build_5
  extends:
  - .image_builder_template
  variables:
    OCI_IMAGE: ska-tango-images-tango-panic-gui
    BASE_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/ska-tango-images-pytango-builder
  rules:
    - !reference [.tango-panic-gui-rules, rules]

test-chart-templates:
  stage: test
  variables:
    MINIKUBE: "false"
  tags:
  - aws-k8srunner
  image: $SKA_K8S_TOOLS_DEPLOY_IMAGE
  script:
    - helm plugin install https://github.com/quintush/helm-unittest
    - make k8s-chart-test
    - mkdir -p ./build/reports
    - mv charts/build/chart_template_tests.xml ./build/reports/chart_template_tests.xml
  artifacts:
    name: "$CI_PROJECT_NAME-$CI_JOB_ID"
    paths:
      - "build/"
    reports:
      junit: build/reports/chart_template_tests.xml

# Custom OCI Image publish stage
oci-image-publish: #Executed on a tag for CAR
  stage: publish
  image: $SKA_K8S_TOOLS_DOCKER_BUILDER_IMAGE
  tags:
    - aws-k8srunner
  before_script:
    - '[ -f .make/oci.mk ] || (echo "File oci.mk not included in Makefile; exit 1")'
    - 'make help | grep oci-publish'
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
    - echo $CAR_OCI_REGISTRY_PASSWORD | docker login -u $CAR_OCI_REGISTRY_USERNAME --password-stdin $CAR_OCI_REGISTRY_HOST
  script:
    - make custom-oci-publish-all
  rules:
    - if: '$CI_COMMIT_TAG'

scan_tango-dependencies:
  extends: 
  - .container-scanning
  variables:
    OCI_IMAGE: ska-tango-images-tango-dependencies 
  rules:
    - !reference [.tango-dependencies_rules, rules]

scan_tango-db:
  extends: 
  - .container-scanning
  variables:
    OCI_IMAGE: ska-tango-images-tango-db
  rules:
    - !reference [.build_tango-db-rules, rules]

scan_tango-cpp:
  extends: 
  - .container-scanning
  variables:
    OCI_IMAGE: ska-tango-images-tango-cpp
  rules:
    - !reference [.tango-cpp-rules, rules]

scan_tango-java:
  extends: 
  - .container-scanning
  variables:
    OCI_IMAGE: ska-tango-images-tango-java
  rules:
    - !reference [.tango-java-rules, rules]

scan_tango-rest:
  extends: 
  - .container-scanning
  variables:
    OCI_IMAGE: ska-tango-images-tango-rest
  rules:
    - !reference [.tango-rest-rules, rules]

scan_pytango-builder:
  extends: 
  - .container-scanning
  variables:
    OCI_IMAGE: ska-tango-images-pytango-builder
  rules:
   !reference [.pytango-builder-rules, rules]

scan_tango-pogo:
  extends: 
  - .container-scanning
  variables:
    OCI_IMAGE: ska-tango-images-tango-pogo
  rules:
    - !reference [.tango-pogo-rules, rules]

scan_tango-libtango:
  extends: 
  - .container-scanning
  variables:
    OCI_IMAGE: ska-tango-images-tango-libtango
  rules:
    - !reference [.tango-libtango-rules, rules]

scan_tango-jive:
  extends: 
  - .container-scanning
  variables:
    OCI_IMAGE: ska-tango-images-tango-jive
  rules:
    - !reference [.tango-jive-rules, rules]

scan_pytango-runtime:
  extends: 
  - .container-scanning
  variables:
    OCI_IMAGE: ska-tango-images-pytango-runtime
  rules:
    - !reference [.pytango-runtime-rules, rules]

scan_tango-admin:
  extends: 
  - .container-scanning
  variables:
    OCI_IMAGE: ska-tango-images-tango-admin
  rules:
    - !reference [.tango-admin-rules, rules]
scan_tango-databaseds:
  extends: 
  - .container-scanning
  variables:
    OCI_IMAGE: ska-tango-images-tango-databaseds
  rules:
    - !reference [.tango-databaseds-rules, rules]

scan_tango-test:
  extends: 
  - .container-scanning
  variables:
    OCI_IMAGE: ska-tango-images-tango-test
  rules:
    - !reference [.tango-test-rules, rules]

scan_tango-dsconfig:
  extends: 
  - .container-scanning
  variables:
    OCI_IMAGE: ska-tango-images-tango-dsconfig
  rules:
    - !reference [.tango-dsconfig-rules, rules]

scan_tango-itango:
  extends: 
  - .container-scanning
  variables:
    OCI_IMAGE: ska-tango-images-tango-itango
  rules:
    - !reference [.tango-itango-rules, rules]

scan_tango-vnc:
  extends: 
  - .container-scanning
  variables:
    OCI_IMAGE: ska-tango-images-tango-vnc
  rules:
    - !reference [.tango-vnc-rules, rules]

scan_tango-pytango:
  extends: 
  - .container-scanning
  variables:
    OCI_IMAGE: ska-tango-images-tango-pytango
  rules:
    - !reference [.tango-pytango-rules, rules]

.scan_tango-panic:
  extends: 
  - .container-scanning
  variables:
    OCI_IMAGE: ska-tango-images-tango-panic
  rules:
    - !reference [.tango-panic-rules, rules]

.scan_tango-panic-gui:
  extends: 
  - .container-scanning
  variables:
    OCI_IMAGE: ska-tango-images-tango-panic-gui
  rules:
    - !reference [.tango-panic-gui-rules, rules]

# Include CI templates
include:
# OCI Images
  # do a custom set of build and publish stages
  - project: 'ska-telescope/templates-repository'
    file: 'gitlab-ci/includes/oci-image-lint.gitlab-ci.yml'

# Helm Charts
  - project: 'ska-telescope/templates-repository'
    file: 'gitlab-ci/includes/helm-chart.gitlab-ci.yml'

  # Raw
  - project: 'ska-telescope/templates-repository'
    file: 'gitlab-ci/includes/raw.gitlab-ci.yml'

# Docs pages
  - project: 'ska-telescope/templates-repository'
    file: 'gitlab-ci/includes/docs-pages.gitlab-ci.yml'

# .post step finalisers eg: badges
  - project: 'ska-telescope/templates-repository'
    file: 'gitlab-ci/includes/finaliser.gitlab-ci.yml'

# k8s steps
  - project: 'ska-telescope/templates-repository'
    file: 'gitlab-ci/includes/k8s.gitlab-ci.yml'

# changelog release page
  - project: 'ska-telescope/templates-repository'
    file: 'gitlab-ci/includes/changelog.gitlab-ci.yml'

  - project: 'ska-telescope/templates-repository'
    file: 'gitlab-ci/includes/oci-image-scan.gitlab-ci.yml'

##### Test k8s
k8s-test:
  before_script:
    - '[ -f .make/k8s.mk ] || (echo "File k8s.mk not included in Makefile; exit 1")'
    - 'make help | grep k8s-test'
    - make k8s-install-chart CAR_OCI_REGISTRY_HOST=${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}
    - make k8s-wait

##### Overide scanning jobs

oci-image-scan:
  before_script:
    - echo "" 
  after_script:
  script:
    - echo "The default scan job is overwritten in this CI/CD. Please see other jobs in the scan stage"

.container-scanning:
  stage: scan
  tags:
    - k8srunner
  image:
    name: $SKA_TRIVY_IMAGE
    entrypoint: [""]
  variables:
  allow_failure: true
  before_script:
  - |
    apk add bash make curl
  script:
  - make oci-scan OCI_IMAGE=${OCI_IMAGE} CAR_OCI_REGISTRY_HOST=${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME} RELEASE_CONTEXT_DIR=images/${OCI_IMAGE}
  cache:
    paths:
      - .trivycache/
  artifacts:
    when: always
    reports:
      container_scanning: gl-container-scanning-report.json

#### Override runner

default:
  tags:
    - aws-k8sruner

oci-image-lint:
  tags:
    - aws-k8srunner

helm-chart-lint:
  tags:
    - aws-k8srunner

helm-chart-build:
  tags:
    - aws-k8srunner

".helm-chart-publish-template":
  tags:
    - aws-k8srunner

helm-chart-publish:
  tags:
    - aws-k8srunner

raw-build:
  tags:
    - aws-k8srunner

raw-publish:
  tags:
    - aws-k8srunner

docs-pages:
  tags:
    - aws-k8srunner

create-ci-metrics:
  tags:
    - aws-k8srunner

k8s-test:
  tags:
    - aws-k8srunner

stop-k8s-test:
  tags:
    - aws-k8srunner

build-changelog:
  tags:
    - aws-k8srunner

oci-image-scan:
  tags:
    - aws-k8srunner

oci-image-scan-from-car:
  tags:
    - aws-k8srunner
